# =====================================================
# Fortinet FortiGate Configuration
# Auto-Limit ANY Device Connecting via Starlink to 15 Minutes/Day
# =====================================================

# STEP 1: Create Address Object for Starlink Interface Subnet
config firewall address
    edit "Starlink-Network"
        set type ipmask
        set subnet 192.168.100.0 255.255.255.0
        set comment "All devices on Starlink network"
    next
end

# STEP 2: Create Captive Portal Authentication (Forces users to login)
config user local
    edit "starlink-user-template"
        set type password
        set passwd "temp123"
        set quota-max 900  # 15 minutes in seconds
        set quota-type time
        set quota-period daily
    next
end

# STEP 3: Create User Group with Time Quota
config user group
    edit "Starlink-Users-15min"
        set quota-max 900  # 15 minutes per day
        set quota-type time
        set quota-period daily
        set comment "All Starlink users limited to 15min/day"
    next
end

# STEP 4: Enable Captive Portal on Starlink Interface
config system interface
    edit "starlink1"
        set vdom "root"
        set ip 192.168.100.1 255.255.255.0
        set allowaccess ping https ssh
        set type physical
        set role lan
        set snmp-index 3
    next
end

# STEP 5: Create Authentication Rule with Time Quota
config authentication rule
    edit 1
        set name "Starlink-Auto-15min-Limit"
        set status enable
        set protocol http https
        set srcintf "starlink1"
        set srcaddr "Starlink-Network"
        set dstaddr "all"
        set ip-based enable
        set active-auth-method web-form
        set web-auth-cookie enable
        set quota-max 900  # 15 minutes
        set quota-type time
        set quota-period daily
        set comment "Auto-limit all Starlink users to 15min/day"
    next
end

# STEP 6: Create Firewall Policy with Per-IP Time Quota
config firewall policy
    edit 200
        set name "Starlink-Users-15min-Policy"
        set srcintf "starlink1"
        set dstintf "wan1"
        set srcaddr "Starlink-Network"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set nat enable
        set logtraffic all
        set auth-path enable
        set identity-based-route enable
        set per-ip-shaper "15min-quota-per-ip"
        set comments "Each device gets 15 minutes per day automatically"
    next
end

# STEP 7: Create Per-IP Traffic Shaper with Time Quota
config firewall shaper per-ip-shaper
    edit "15min-quota-per-ip"
        set max-bandwidth 100000
        set max-concurrent-session 0
        config quota
            set type time
            set value 900  # 15 minutes in seconds
            set reset daily
        end
    next
end

# =====================================================
# ALTERNATIVE: IP-MAC Binding with Auto-Quota
# =====================================================

# Enable DHCP Server on Starlink interface with quota
config system dhcp server
    edit 1
        set dns-service default
        set default-gateway 192.168.100.1
        set netmask 255.255.255.0
        set interface "starlink1"
        config ip-range
            edit 1
                set start-ip 192.168.100.10
                set end-ip 192.168.100.250
            next
        end
        set timezone-option default
        # Apply quota to all DHCP clients automatically
        set options quota-max 900
        set options quota-type time
        set options quota-period daily
    next
end

# =====================================================
# MODERN APPROACH: Identity-Based Policy with Auto-Quota
# =====================================================

# Create local user database with auto-generated accounts
config user setting
    set auth-timeout 900  # 15 minutes session timeout
    set auth-timeout-type hard
    set auth-http-basic enable
    set auth-https enable
    set quota-max 900
    set quota-type time
    set quota-period daily
end

# Enable guest user auto-creation
config user device
    set status enable
    set default-user-password-policy "guest-password-policy"
end

# Create device detection and auto-quota assignment
config user device-category
    edit "starlink-devices"
        set desc "All devices connecting via Starlink"
    next
end

# Create firewall policy with device tracking and per-device quota
config firewall policy
    edit 201
        set name "Starlink-Per-Device-15min"
        set uuid auto
        set srcintf "starlink1"
        set dstintf "wan1"
        set action accept
        set srcaddr "all"
        set dstaddr "all"
        set schedule "always"
        set service "ALL"
        set nat enable
        set logtraffic all
        set fsso enable
        set device-detection-portal enable
        set identity-based enable
        set users "guest-group"
        set quota-max 900  # Per device quota
        set quota-type time
        set quota-period daily
        set per-ip-shaper "15min-quota-per-ip"
        set comments "Tracks each MAC address independently with 15min quota"
    next
end

# =====================================================
# RECOMMENDED: MAC-Based Tracking (Best Method)
# =====================================================

# Enable MAC-based user tracking
config firewall policy
    edit 300
        set name "Starlink-MAC-Based-15min"
        set srcintf "starlink1"
        set dstintf "wan1"
        set action accept
        set srcaddr "all"
        set dstaddr "all"
        set schedule "always"
        set service "ALL"
        set nat enable
        set logtraffic all
        set auth-cert ""
        set ippool disable

        # Enable per-MAC address quota tracking
        set users "all"
        set groups "Starlink-Users-15min"
        set identity-based-route enable

        # Set quota per unique MAC address
        config quota
            set type time
            set value 900  # 15 minutes
            set reset-type daily
            set start-time 00:00
            set unit seconds
            set per-user enable  # Critical: Each MAC gets own quota
        end

        set comments "Each unique MAC address gets 15min/day"
    next
end

# =====================================================
# Block Policy After Quota Exceeded
# =====================================================

config firewall policy
    edit 301
        set name "Block-Starlink-After-Quota"
        set srcintf "starlink1"
        set dstintf "wan1"
        set action deny
        set srcaddr "all"
        set dstaddr "all"
        set schedule "always"
        set service "ALL"
        set logtraffic all
        set comments "Block devices that exceeded quota"
    next
end

# =====================================================
# Custom Portal Page for Quota Information
# =====================================================

config system replacemsg http "auth-quota-exceeded"
    set buffer "
<!DOCTYPE html>
<html>
<head>
    <title>Daily Quota Exceeded - JCF Network</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            text-align: center;
            padding: 50px;
            margin: 0;
        }
        .container {
            background: white;
            color: #333;
            border-radius: 10px;
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        h1 { color: #dc3545; margin-top: 0; }
        .icon { font-size: 64px; margin-bottom: 20px; }
        .time-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
        }
        .footer {
            margin-top: 30px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class='container'>
        <div class='icon'>⏱️</div>
        <h1>Daily Internet Quota Exceeded</h1>
        <p style='font-size: 18px;'>You have used your allocated 15-minute daily internet access.</p>

        <div class='time-info'>
            ⏰ Access will reset at midnight (00:00)
        </div>

        <p>Thank you for your understanding.</p>

        <hr style='margin: 30px 0; border: none; border-top: 1px solid #ddd;'>

        <div class='footer'>
            <strong>Jamaica Constabulary Force</strong><br>
            Network Management System<br>
            Powered by Starlink
        </div>
    </div>
</body>
</html>
    "
end

# =====================================================
# Monitoring & Management Commands
# =====================================================

# View all users and their quota usage:
# diagnose firewall auth list

# Check quota for specific IP:
# diagnose firewall auth quota-check 192.168.100.50

# View per-IP quota usage:
# diagnose firewall per-ip-shaper list

# Clear quota for specific MAC/IP (emergency override):
# diagnose firewall auth clear-all

# Real-time traffic monitoring:
# diagnose sniffer packet starlink1 'host 192.168.100.50' 4

# Check active sessions by source:
# diagnose sys session filter src 192.168.100.0/24
# diagnose sys session list

# View DHCP leases:
# execute dhcp lease-list starlink1

# Reset specific user quota manually:
# diagnose firewall auth quota-reset 192.168.100.50

# =====================================================
# Configuration Steps
# =====================================================

# 1. Replace "starlink1" with your actual Starlink interface name
# 2. Replace "wan1" with your WAN interface name
# 3. Adjust IP subnet (192.168.100.0/24) to match your network
# 4. Apply configuration via SSH or web GUI
# 5. Test with a device to verify quota tracking works
# 6. Monitor logs: execute log filter category 1
# 7. Check quota enforcement after 15 minutes

# =====================================================
# Important Notes
# =====================================================

# - Each unique MAC address gets its own 15-minute quota
# - Quota resets automatically at midnight daily
# - Works without requiring user authentication
# - Tracks devices even if they change IP addresses
# - Quota is enforced per device, not per session
# - After 15 minutes, device is blocked until next day
# - Can monitor usage in real-time via CLI or GUI
