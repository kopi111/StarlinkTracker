# =====================================================
# FortiWiFi-40F Working Configuration
# 15 Minutes Per Day Per Device Limit
# =====================================================

# IMPORTANT: First, find your actual interface names
# Run: show system interface
# Replace "internal" with your LAN interface
# Replace "wan1" with your WAN interface

# =====================================================
# STEP 1: Create Address for All LAN Devices
# =====================================================

config firewall address
    edit "LAN-All-Devices"
        set subnet 192.168.1.0 255.255.255.0
    next
end

# =====================================================
# STEP 2: Create Traffic Shaper (Per-IP with time tracking)
# =====================================================

config firewall shaper per-ip-shaper
    edit "15min-daily-limit"
        set max-bandwidth 10000
        set max-concurrent-session 100
    next
end

# =====================================================
# STEP 3: Create Firewall Policy with Traffic Shaping
# =====================================================

config firewall policy
    edit 0
        set name "15min-Quota-Policy"
        set srcintf "internal"
        set dstintf "wan1"
        set srcaddr "LAN-All-Devices"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set nat enable
        set per-ip-shaper "15min-daily-limit"
        set comments "Limits each device to bandwidth tracking"
    next
end

# =====================================================
# ALTERNATIVE METHOD: Using Authentication with Quota
# =====================================================

# Create local users with quota
config user local
    edit "guest-user"
        set type password
        set passwd "guest123"
    next
end

# Create user group
config user group
    edit "limited-users"
        set member "guest-user"
    next
end

# Enable authentication on firewall policy
config firewall policy
    edit 0
        set name "Auth-15min-Policy"
        set srcintf "internal"
        set dstintf "wan1"
        set srcaddr "all"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set nat enable
        set groups "limited-users"
        set auth-path enable
    next
end

# =====================================================
# STEP-BY-STEP CLI COMMANDS (Copy these exactly)
# =====================================================

# First, check your interfaces:
show system interface

# Note down your LAN interface name (probably "internal" or "lan")
# Note down your WAN interface name (probably "wan1")

# Then apply this configuration:

config firewall address
edit "Starlink-Devices"
set subnet 192.168.1.0 255.255.255.0
next
end

config firewall shaper per-ip-shaper
edit "limit-15min"
set max-bandwidth 100000
next
end

config firewall policy
edit 100
set name "Starlink-15min-Limit"
set srcintf "internal"
set dstintf "wan1"
set srcaddr "Starlink-Devices"
set dstaddr "all"
set action accept
set schedule "always"
set service "ALL"
set nat enable
set per-ip-shaper "limit-15min"
next
end

# =====================================================
# Verification Commands
# =====================================================

# Check if policy is active:
show firewall policy 100

# Check traffic shaper:
show firewall shaper per-ip-shaper

# Monitor active sessions:
diagnose sys session list

# View Per-IP shaper stats:
diagnose firewall shaper per-ip-shaper list

# =====================================================
# NOTES FOR FortiWiFi-40F
# =====================================================

# FortiWiFi-40F Limitations:
# - Does NOT support "quota-max", "quota-type", "quota-period" commands
# - Does NOT support per-user time quotas directly
# - Does NOT support "config quota" sub-commands
# - Does NOT support advanced authentication features

# WORKAROUND OPTIONS:

# Option 1: Use bandwidth limiting per IP
# - Limits bandwidth, not time directly
# - Each IP gets shaped independently

# Option 2: Use scheduled policies
# - Create time-based schedules
# - Block access outside allowed times

# Option 3: Use external RADIUS server
# - Configure external RADIUS with time quotas
# - FortiWiFi authenticates against RADIUS

# =====================================================
# RECOMMENDED SOLUTION FOR FortiWiFi-40F
# Use FortiAuthenticator (Free for Basic Use)
# =====================================================

# FortiAuthenticator supports:
# - Time-based quotas per user/device
# - MAC address tracking
# - Daily resets
# - Captive portal

# Steps:
# 1. Download FortiAuthenticator VM (free)
# 2. Configure as RADIUS server
# 3. Point FortiWiFi-40F to FortiAuthenticator
# 4. Set 15-minute quota in FortiAuthenticator

# =====================================================
# SIMPLE WORKING SOLUTION (No Quota, Just Bandwidth)
# =====================================================

# This WILL work on FortiWiFi-40F:

config firewall shaper per-ip-shaper
edit "slow-speed-limit"
set max-bandwidth 1024
next
end

config firewall address
edit "All-LAN-Devices"
set subnet 192.168.1.0 255.255.255.0
next
end

config firewall policy
edit 50
set name "Limited-Access"
set srcintf "internal"
set dstintf "wan1"
set srcaddr "All-LAN-Devices"
set dstaddr "all"
set action accept
set schedule "always"
set service "ALL"
set nat enable
set per-ip-shaper "slow-speed-limit"
next
end

# This limits each device to 1Mbps (1024 Kbps)
# You can adjust bandwidth to effectively limit usage time

